openapi: 3.0.3
info:
  title: StayHub API
  version: 1.0.0
  description: >
    OpenAPI dokumentacija za StayHub (Next.js App Router API rute u app/api).
    Auth je cookie-based (HttpOnly cookie). U Swagger UI pozovi /api/auth/login,
    pa će naredni pozivi slati cookie (credentials=include).

servers:
  - url: http://localhost:3000

tags:
  - name: Auth
  - name: Categories
  - name: Properties
  - name: Reservations
  - name: Seller
  - name: Admin

components:
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: stayhub_session

  schemas:
    ErrorResponse:
      type: object
      properties:
        message: { type: string }
      required: [message]

    OkEnvelope:
      type: object
      properties:
        ok: { type: boolean }
        data: {}
      required: [ok]

    Role:
      type: string
      enum: [ADMIN, SELLER, BUYER]

    User:
      type: object
      properties:
        id: { type: integer, format: int32 }
        name: { type: string }
        email: { type: string, format: email }
        role: { $ref: "#/components/schemas/Role" }
      required: [id, name, email, role]

    Category:
      type: object
      properties:
        id: { type: integer, format: int32 }
        name: { type: string }
        description:
          type: string
          nullable: true
      required: [id, name]

    Location:
      type: object
      properties:
        address: { type: string }
        city: { type: string }
      required: [address, city]

    Property:
      type: object
      properties:
        id: { type: integer, format: int32 }
        name: { type: string }
        description: { type: string }
        image: { type: string }
        price:
          oneOf:
            - type: number
            - type: string
        rooms: { type: integer, format: int32 }
        location: { $ref: "#/components/schemas/Location" }
        category:
          allOf:
            - $ref: "#/components/schemas/Category"
          nullable: true
        seller:
          allOf:
            - $ref: "#/components/schemas/User"
          nullable: true
      required: [id, name, description, image, price, rooms, location]

    PropertiesPaged:
      type: object
      properties:
        items:
          type: array
          items: { $ref: "#/components/schemas/Property" }
        total: { type: integer, format: int32 }
        page: { type: integer, format: int32 }
        pageSize: { type: integer, format: int32 }
      required: [items, total, page, pageSize]

    ReservationStatus:
      type: string
      enum: [PENDING, CONFIRMED, CANCELLED, COMPLETED]

    Reservation:
      type: object
      properties:
        id: { type: integer, format: int32 }
        propertyId: { type: integer, format: int32 }
        buyerId: { type: integer, format: int32 }
        sellerId: { type: integer, format: int32 }
        startDate:
          type: string
          format: date-time
        endDate:
          type: string
          format: date-time
        guests: { type: integer, format: int32 }
        totalPrice:
          type: number
        status: { $ref: "#/components/schemas/ReservationStatus" }
        property:
          allOf:
            - $ref: "#/components/schemas/Property"
          nullable: true
      required: [id, propertyId, buyerId, sellerId, startDate, endDate, guests, totalPrice, status]

    ReservationsList:
      type: object
      properties:
        items:
          type: array
          items: { $ref: "#/components/schemas/Reservation" }
      required: [items]

    AdminMetrics:
      type: object
      properties:
        totalUsers: { type: integer }
        totalProperties: { type: integer }
        totalReservations: { type: integer }
        reservationsByStatus:
          type: object
          additionalProperties: { type: integer }
        revenueByMonth:
          type: array
          items:
            type: object
            properties:
              month: { type: string }
              total: { type: number }
            required: [month, total]
      required: [totalUsers, totalProperties, totalReservations, reservationsByStatus, revenueByMonth]

    SellersList:
      type: object
      properties:
        items:
          type: array
          items: { $ref: "#/components/schemas/User" }
      required: [items]

    ReservationsReport:
      type: object
      properties:
        from:
          type: string
          nullable: true
        to:
          type: string
          nullable: true
        items:
          type: array
          items: { $ref: "#/components/schemas/Reservation" }
      required: [items]

paths:
  /api/auth/register:
    post:
      tags: [Auth]
      summary: Register
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name: { type: string, minLength: 1 }
                email: { type: string, format: email }
                password: { type: string, minLength: 6 }
                role:
                  $ref: "#/components/schemas/Role"
              required: [name, email, password, role]
      responses:
        "200":
          description: Registered
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "#/components/schemas/User"
                  - $ref: "#/components/schemas/OkEnvelope"
        "409":
          description: Conflict
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "422":
          description: Validation error
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /api/auth/login:
    post:
      tags: [Auth]
      summary: Login (sets HttpOnly cookie)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email: { type: string, format: email }
                password: { type: string, minLength: 1 }
              required: [email, password]
      responses:
        "200":
          description: Logged in (cookie set)
          headers:
            Set-Cookie:
              schema: { type: string }
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    allOf:
                      - $ref: "#/components/schemas/User"
                    nullable: true
                required: [user]
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /api/auth/logout:
    post:
      tags: [Auth]
      summary: Logout (clears cookie)
      security:
        - cookieAuth: []
      responses:
        "200":
          description: Logged out
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "#/components/schemas/OkEnvelope"
                  - type: object
                    properties:
                      ok: { type: boolean }
                    required: [ok]

  /api/auth/me:
    get:
      tags: [Auth]
      summary: Current user
      security:
        - cookieAuth: []
      responses:
        "200":
          description: Me
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    allOf:
                      - $ref: "#/components/schemas/User"
                    nullable: true
                required: [user]
        "401":
          description: Not logged in
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /api/categories:
    get:
      tags: [Categories]
      summary: List categories
      responses:
        "200":
          description: Categories
          content:
            application/json:
              schema:
                oneOf:
                  - type: object
                    properties:
                      items:
                        type: array
                        items: { $ref: "#/components/schemas/Category" }
                    required: [items]
                  - type: array
                    items: { $ref: "#/components/schemas/Category" }

  /api/properties:
    get:
      tags: [Properties]
      summary: List properties (paged + filters)
      parameters:
        - in: query
          name: name
          schema: { type: string }
        - in: query
          name: city
          schema: { type: string }
        - in: query
          name: categoryId
          schema: { type: integer, format: int32 }
        - in: query
          name: minPrice
          schema: { type: number }
        - in: query
          name: maxPrice
          schema: { type: number }
        - in: query
          name: minRooms
          schema: { type: integer, format: int32 }
        - in: query
          name: maxRooms
          schema: { type: integer, format: int32 }
        - in: query
          name: sortBy
          schema:
            type: string
            enum: [name, price, rooms, city]
        - in: query
          name: order
          schema:
            type: string
            enum: [asc, desc]
        - in: query
          name: page
          schema: { type: integer, default: 1 }
        - in: query
          name: pageSize
          schema: { type: integer, default: 6 }
      responses:
        "200":
          description: Paged properties
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "#/components/schemas/PropertiesPaged"
                  - $ref: "#/components/schemas/OkEnvelope"

    post:
      tags: [Properties]
      summary: Create property (SELLER only)
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name: { type: string, minLength: 1 }
                description: { type: string, minLength: 1 }
                image: { type: string, minLength: 1 }
                price: { type: number, minimum: 0 }
                rooms: { type: integer, minimum: 0 }
                location:
                  $ref: "#/components/schemas/Location"
                categoryId:
                  type: integer
                  format: int32
                  nullable: true
              required: [name, description, image, price, rooms, location]
      responses:
        "200":
          description: Created
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "#/components/schemas/Property"
                  - $ref: "#/components/schemas/OkEnvelope"
        "403":
          description: Forbidden (role)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /api/properties/{id}:
    get:
      tags: [Properties]
      summary: Get property by id
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, format: int32 }
      responses:
        "200":
          description: Property
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "#/components/schemas/Property"
                  - $ref: "#/components/schemas/OkEnvelope"
        "404":
          description: Not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

    patch:
      tags: [Properties]
      summary: Update property (SELLER only)
      security:
        - cookieAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, format: int32 }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              description: Partial update (fields depend on updatePropertySchema).
              properties:
                name: { type: string }
                description: { type: string }
                image: { type: string }
                price: { type: number }
                rooms: { type: integer }
                location: { $ref: "#/components/schemas/Location" }
                categoryId:
                  type: integer
                  format: int32
                  nullable: true
      responses:
        "200":
          description: Updated
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "#/components/schemas/Property"
                  - $ref: "#/components/schemas/OkEnvelope"
        "403":
          description: Forbidden (role)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

    delete:
      tags: [Properties]
      summary: Delete property (SELLER only)
      security:
        - cookieAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, format: int32 }
      responses:
        "200":
          description: Deleted
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "#/components/schemas/OkEnvelope"
                  - type: object
                    properties:
                      ok: { type: boolean }
                    required: [ok]
        "403":
          description: Forbidden (role)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /api/reservations:
    get:
      tags: [Reservations]
      summary: List reservations (BUYER only)
      security:
        - cookieAuth: []
      responses:
        "200":
          description: Reservations
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "#/components/schemas/ReservationsList"
                  - $ref: "#/components/schemas/OkEnvelope"

    post:
      tags: [Reservations]
      summary: Create reservation (BUYER only)
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                propertyId: { type: integer, format: int32 }
                startDate:
                  type: string
                  format: date-time
                  description: ISO date-time, npr. 2026-01-03T10:00:00.000Z
                endDate:
                  type: string
                  format: date-time
                  description: ISO date-time, npr. 2026-01-05T10:00:00.000Z
                guests:
                  type: integer
                  format: int32
                  nullable: true
                  description: Ako backend podržava; u ruti se ne vidi u ZIP-u.
              required: [propertyId, startDate, endDate]
      responses:
        "200":
          description: Created reservation
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "#/components/schemas/Reservation"
                  - $ref: "#/components/schemas/OkEnvelope"
        "400":
          description: Validation / business rule
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "403":
          description: Forbidden (role)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /api/reservations/my:
    get:
      tags: [Reservations]
      summary: List my reservations (BUYER only)
      security:
        - cookieAuth: []
      responses:
        "200":
          description: My reservations
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "#/components/schemas/ReservationsList"
                  - $ref: "#/components/schemas/OkEnvelope"

  /api/reservations/{id}:
    get:
      tags: [Reservations]
      summary: Get reservation by id (BUYER only)
      security:
        - cookieAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, format: int32 }
      responses:
        "200":
          description: Reservation
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "#/components/schemas/Reservation"
                  - $ref: "#/components/schemas/OkEnvelope"
        "404":
          description: Not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /api/reservations/{id}/cancel:
    patch:
      tags: [Reservations]
      summary: Cancel reservation (BUYER only)
      security:
        - cookieAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, format: int32 }
      responses:
        "200":
          description: Cancelled
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "#/components/schemas/Reservation"
                  - $ref: "#/components/schemas/OkEnvelope"
        "400":
          description: Cannot cancel (rule)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /api/seller/reservations:
    get:
      tags: [Seller]
      summary: List reservations for seller (SELLER only)
      security:
        - cookieAuth: []
      responses:
        "200":
          description: Seller reservations
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "#/components/schemas/ReservationsList"
                  - $ref: "#/components/schemas/OkEnvelope"

  /api/seller/reservations/{id}:
    get:
      tags: [Seller]
      summary: Get seller reservation by id (SELLER only)
      security:
        - cookieAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, format: int32 }
      responses:
        "200":
          description: Reservation
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "#/components/schemas/Reservation"
                  - $ref: "#/components/schemas/OkEnvelope"

  /api/seller/reservations/{id}/status:
    patch:
      tags: [Seller]
      summary: Update reservation status (SELLER only)
      security:
        - cookieAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, format: int32 }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                status: { $ref: "#/components/schemas/ReservationStatus" }
              required: [status]
      responses:
        "200":
          description: Updated
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "#/components/schemas/Reservation"
                  - $ref: "#/components/schemas/OkEnvelope"

  /api/admin/metrics:
    get:
      tags: [Admin]
      summary: Admin metrics (ADMIN only)
      security:
        - cookieAuth: []
      responses:
        "200":
          description: Metrics
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "#/components/schemas/AdminMetrics"
                  - $ref: "#/components/schemas/OkEnvelope"

  /api/admin/sellers:
    get:
      tags: [Admin]
      summary: List sellers (ADMIN only)
      security:
        - cookieAuth: []
      responses:
        "200":
          description: Sellers
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "#/components/schemas/SellersList"
                  - $ref: "#/components/schemas/OkEnvelope"

  /api/admin/reports/reservations:
    get:
      tags: [Admin]
      summary: Reservations report (ADMIN only)
      security:
        - cookieAuth: []
      parameters:
        - in: query
          name: from
          schema:
            type: string
            format: date-time
            nullable: true
        - in: query
          name: to
          schema:
            type: string
            format: date-time
            nullable: true
      responses:
        "200":
          description: Report
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "#/components/schemas/ReservationsReport"
                  - $ref: "#/components/schemas/OkEnvelope"
